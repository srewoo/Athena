# How to Run Tests

## Prerequisites

1. **Python 3.10+** installed
2. **Virtual environment** activated (recommended)
3. **Dependencies** installed

## Setup Steps

### 1. Navigate to Project Root (NOT backend directory)

```bash
# Make sure you're in the project root (where tests/ folder is)
cd /path/to/Athena
# OR if already in backend, go up one level
cd ..
```

### 2. Activate Virtual Environment

**macOS/Linux:**
```bash
cd backend
source venv/bin/activate
cd ..  # Go back to project root
```

**Windows:**
```bash
cd backend
venv\Scripts\activate
cd ..  # Go back to project root
```

### 3. Install Test Dependencies

```bash
cd backend
pip install -r requirements.txt
cd ..  # Return to project root
```

This will install:
- pytest
- pytest-asyncio
- pytest-cov
- fastapi
- httpx (for TestClient)
- All other dependencies

## Running Tests

### Option 1: Using the Test Runner Script (Recommended)

The easiest way to run tests with coverage:

```bash
# From PROJECT ROOT directory
./run_tests.sh                  # Run with coverage (default)
./run_tests.sh no-coverage      # Run without coverage (faster)
./run_tests.sh debug            # Run with debug output + coverage
```

The script automatically:
- ✅ Checks you're in the correct directory
- ✅ Activates the virtual environment
- ✅ Installs/updates dependencies
- ✅ Generates coverage report at `htmlcov/index.html`
- ✅ Shows color-coded results

### Option 2: Manual pytest Commands

```bash
# From PROJECT ROOT directory (where tests/ folder is located)
pytest tests/ -v
```

**Important:** Run pytest from the project root, not from the `backend/` directory!

### Run All Tests with Detailed Output

```bash
pytest tests/ -v -s
```

The `-s` flag shows print statements and logging output.

### Run Specific Test File

```bash
# Run utility function tests
pytest tests/test_utils.py -v

# Run endpoint tests
pytest tests/test_project_endpoints.py -v

# Run edge case tests
pytest tests/test_edge_cases.py -v

# Run integration tests
pytest tests/test_integration.py -v

# Run storage function tests
pytest tests/test_storage_functions.py -v

# Run LLM client tests
pytest tests/test_llm_client.py -v
```

### Run Specific Test Class

```bash
# Run only TestCreateProject class
pytest tests/test_project_endpoints.py::TestCreateProject -v

# Run only TestCalculateStatistics class
pytest tests/test_edge_cases.py::TestCalculateStatistics -v
```

### Run Specific Test Function

```bash
# Run single test
pytest tests/test_project_endpoints.py::TestCreateProject::test_create_project_success -v
```

### Run Tests with Coverage Report

**Using test runner script (easiest - coverage by default):**

```bash
./run_tests.sh  # Generates coverage automatically

# View HTML report
open htmlcov/index.html      # macOS
xdg-open htmlcov/index.html  # Linux
start htmlcov/index.html     # Windows
```

**Using pytest directly:**

```bash
pytest tests/ --cov=backend.project_api --cov=backend.project_storage --cov=backend.llm_client --cov=backend.smart_test_generator --cov-report=html --cov-report=term -v
```

### Run Tests Matching a Pattern

```bash
# Run all tests with "edge" in the name
pytest tests/ -k "edge" -v

# Run all tests with "storage" in the name
pytest tests/ -k "storage" -v

# Run all tests with "test_create" in the name
pytest tests/ -k "test_create" -v
```

### Run Tests in Parallel (Faster)

```bash
# Install pytest-xdist first
pip install pytest-xdist

# Run tests in parallel (4 workers)
pytest tests/ -n 4 -v
```

### Run Tests and Stop on First Failure

```bash
pytest tests/ -x -v
```

### Run Tests with Verbose Output and Show Local Variables on Failure

```bash
pytest tests/ -v -l
```

### Run Only Fast Tests (Exclude Slow/Integration)

```bash
pytest tests/ -v -m "not slow"
```

## Common Test Commands

### Quick Test Run (Most Common)

```bash
# Step 1: Activate virtual environment
cd backend
source venv/bin/activate  # or venv\Scripts\activate on Windows

# Step 2: Go back to project root
cd ..

# Step 3: Run tests
pytest tests/ -v
```

**OR** run from project root with full path:

```bash
# From project root
backend/venv/bin/pytest tests/ -v
```

### Full Coverage Report

**Using test runner script (recommended):**

```bash
./run_tests.sh  # Coverage generated by default at htmlcov/index.html
```

**Manual approach:**

```bash
# Activate venv
cd backend
source venv/bin/activate
cd ..  # Back to project root

# Run with coverage
pytest tests/ --cov=backend.project_api --cov=backend.project_storage --cov=backend.llm_client --cov=backend.smart_test_generator --cov-report=html --cov-report=term-missing
```

### Run Tests and Show Output

```bash
pytest tests/ -v -s --tb=short
```

## Test Output Explanation

### Successful Test Run

```
tests/test_utils.py::TestSanitizeForEval::test_sanitize_normal_text PASSED
tests/test_utils.py::TestSanitizeForEval::test_sanitize_empty_string PASSED
...
========================= 238 passed in 15.23s =========================
```

### Failed Test

```
tests/test_project_endpoints.py::TestCreateProject::test_create_project_success FAILED
...
AssertionError: assert response.status_code == 200
```

## Troubleshooting

### Issue: ModuleNotFoundError or "file or directory not found: tests/"

**Solution:** Make sure you're in the **project root** directory (where `tests/` folder is), not in `backend/`:

```bash
# Check you're in the right place (should see tests/ folder)
ls tests/

# If you're in backend/, go up one level
cd ..

# Then run tests
pytest tests/ -v
```

### Issue: Tests can't find backend modules

**Solution:** The tests automatically add backend to the path, but if issues persist:

```bash
# Run from project root with PYTHONPATH set
PYTHONPATH=backend pytest tests/ -v
```

### Issue: Import Errors

**Solution:** Check that all dependencies are installed:

```bash
pip install -r requirements.txt
```

### Issue: Tests Creating Files in saved_projects

**Solution:** Tests clean up after themselves, but if you see test files:

```bash
# Clean up test files manually
cd backend
rm -rf saved_projects/test_*.json
```

### Issue: Async Test Errors

**Solution:** Make sure `pytest-asyncio` is installed:

```bash
pip install pytest-asyncio
```

### Issue: Permission Errors

**Solution:** Check file permissions on `saved_projects` directory:

```bash
chmod -R 755 backend/saved_projects
```

## Continuous Integration (CI) Example

For CI/CD pipelines, use:

```bash
pytest tests/ --cov=project_api --cov=project_storage --cov=llm_client --cov-report=xml --cov-report=term --junitxml=junit.xml
```

## Test Organization

```
tests/
├── conftest.py                  # Shared fixtures
├── test_utils.py                # Utility function tests
├── test_project_storage.py      # Basic storage tests
├── test_storage_functions.py    # Advanced storage tests
├── test_project_endpoints.py    # API endpoint tests
├── test_advanced_endpoints.py   # Advanced feature tests
├── test_llm_client.py           # LLM client tests (mocked)
├── test_edge_cases.py           # Edge case tests
├── test_integration.py          # Integration tests
├── test_run_single_test_case.py # Test execution tests
├── test_smart_test_generator.py # Smart generator tests
└── test_prompt_analyzer.py     # Prompt analyzer tests
```

## Expected Test Count

- **Total Tests**: 238+ tests
- **Expected Runtime**: 15-30 seconds (depending on system)
- **Coverage Target**: 100% code coverage

## Quick Reference

```bash
# Most common commands
pytest tests/ -v                          # Run all tests
pytest tests/ -v -s                      # Run with output
pytest tests/ --cov --cov-report=html    # Coverage report
pytest tests/ -k "test_create" -v       # Filter tests
pytest tests/ -x                         # Stop on first failure
```
